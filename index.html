<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Keep‑like Tasks App (Sheets ↔ Calendar)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input, select, button, textarea { padding:8px; font-size:14px; }
    button { cursor:pointer; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin:8px 0; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; }
    th { background:#fafafa; position: sticky; top: 0; }
    .muted { color:#666; }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f3f3; margin-right:6px; }
    .right { float:right; }
    .danger { color:#b00020; }
    .success { color:#006400; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }
  </style>
</head>
<body>
  <header>
    <strong>Backend URL:</strong>
    <input id="webAppUrl" placeholder="https://script.google.com/macros/s/.../exec" style="min-width:420px" />
    <button onclick="saveUrl()">Save URL</button>
    <button onclick="testConnection()">Test Connection</button>
    <span id="status" class="muted"></span>
  </header>

  <div class="card">
    <h3>Settings</h3>
    <div class="grid">
      <label>Sheet ID<br/><input id="sheetId" placeholder="1abcDEF..."/></label>
      <label>Target Calendar ID<br/><input id="calendarId" placeholder="primary or your@domain.com"/></label>
      <label>Default Timezone<br/>
        <input id="defaultTimezone" value="America/Toronto"/>
      </label>
      <label>Max Reminders<br/>
        <input id="maxReminders" type="number" min="1" max="5" value="5"/>
      </label>
    </div>
    <div class="row">
      <button onclick="loadSettings()">Load Settings</button>
      <button onclick="saveSettings()">Save Settings</button>
      <button onclick="initTemplate()">Initialize Template</button>
    </div>
  </div>

  <div class="card">
    <h3>Create / Edit Task</h3>
    <div class="grid">
      <label>Subject<br/><input id="t_subject"/></label>
      <label>Start Date (YYYY-MM-DD)<br/><input id="t_startDate" placeholder="2025-09-07"/></label>
      <label>All‑day?<br/>
        <select id="t_allDay" onchange="toggleAllDay()">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </label>
      <label>Start Time (HH:MM)<br/><input id="t_startTime" placeholder="08:00"/></label>
      <label>End Date (optional)<br/><input id="t_endDate" placeholder="2025-09-07"/></label>
      <label>End Time (HH:MM)<br/><input id="t_endTime" placeholder="20:00"/></label>
      <label>Category<br/>
        <select id="t_category">
          <option>Tasks</option><option>Chores</option><option>Important Dates</option><option>Deadlines</option>
          <option>Meetings</option><option>Recharge</option><option>Subscriptions</option><option>Information</option>
          <option>Personal</option><option>Work</option><option>Health</option><option>Finance</option>
          <option>Learning</option><option>Custom</option>
        </select>
      </label>
      <label>Priority<br/>
        <select id="t_priority">
          <option>Medium</option><option>Low</option><option>High</option><option>Urgent</option>
        </select>
      </label>
      <label>Recurrence (RRULE)<br/><input id="t_rrule" placeholder="FREQ=WEEKLY;BYDAY=MO,WE"/></label>
      <label>Repeat Count<br/><input id="t_repeatCount" type="number" min="1" max="1000"/></label>
      <label>Tags (comma‑separated)<br/><input id="t_tags"/></label>
      <label>Notes<br/><textarea id="t_notes" rows="2"></textarea></label>
    </div>
    <div class="row">
      <button onclick="createTask()">Create Task</button>
      <span class="muted">Time rules: if both times empty → defaults to 08:00→20:00; all‑day leaves times blank.</span>
    </div>
  </div>

  <div class="card">
    <h3>Tasks</h3>
    <div class="row">
      <button onclick="loadTasks()">Refresh</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Subject</th>
          <th>Start</th>
          <th>End</th>
          <th>All‑day</th>
          <th>Cat</th>
          <th>Pri</th>
          <th>Recurrence</th>
          <th>Done?</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tasksTbody"></tbody>
    </table>
  </div>

<script>
  const state = {
    url: localStorage.getItem('webAppUrl') || ''
  };
  document.getElementById('webAppUrl').value = state.url;

  function saveUrl(){
    state.url = document.getElementById('webAppUrl').value.trim();
    localStorage.setItem('webAppUrl', state.url);
    setStatus('Saved.', 'success');
  }
  function setStatus(msg, cls){
    const el = document.getElementById('status');
    el.textContent = msg; el.className = cls || 'muted';
  }

  async function callWebApp(action, payload=null, method='POST'){
    if(!state.url) throw new Error('Set the Backend URL first.');
    let url = state.url;
    const options = { method, headers: {}, cache: 'no-store' };
    if(method === 'GET'){
      const u = new URL(url);
      u.searchParams.set('action', action);
      if(payload) u.searchParams.set('payload', JSON.stringify(payload));
      url = u.toString();
    } else {
      const params = new URLSearchParams();
      params.set('action', action);
      if(payload) params.set('payload', JSON.stringify(payload));
      options.headers['Content-Type'] = 'application/x-www-form-urlencoded;charset=UTF-8';
      options.body = params.toString();
    }

    const resp = await fetch(url, options);
    const ct = (resp.headers.get('content-type') || '').toLowerCase();
    if(!ct.includes('application/json')){
      const text = await resp.text();
      throw new Error(`Expected JSON, got ${ct}. First 100 chars: ${text.slice(0,100)}`);
    }
    const data = await resp.json();
    if(!data.success) throw new Error(data.data && data.data.error || 'Unknown server error');
    return data.data;
  }

  async function testConnection(){
    try{
      const out = await callWebApp('testConnection', null, 'POST');
      setStatus(`Connected to "${out.spreadsheetName}" (v${out.version}).`, 'success');
    }catch(e){ setStatus(e.message, 'danger'); }
  }

  async function loadSettings(){
    try{
      const s = await callWebApp('getSettings');
      document.getElementById('sheetId').value = s.sheetId || '';
      document.getElementById('calendarId').value = s.calendarId || '';
      document.getElementById('defaultTimezone').value = s.defaultTimezone || 'America/Toronto';
      document.getElementById('maxReminders').value = s.maxReminders || 5;
      setStatus('Settings loaded.', 'success');
    }catch(e){ setStatus(e.message, 'danger'); }
  }

  async function saveSettings(){
    try{
      const s = {
        sheetId: document.getElementById('sheetId').value.trim(),
        calendarId: document.getElementById('calendarId').value.trim(),
        defaultTimezone: document.getElementById('defaultTimezone').value.trim() || 'America/Toronto',
        maxReminders: Math.min(5, Math.max(1, parseInt(document.getElementById('maxReminders').value||'5',10))),
      };
      await callWebApp('setSettings', s);
      setStatus('Settings saved.', 'success');
    }catch(e){ setStatus(e.message, 'danger'); }
  }

  async function initTemplate(){
    try{ await callWebApp('initTemplate'); setStatus('Template initialized.', 'success'); }
    catch(e){ setStatus(e.message, 'danger'); }
  }

  function toggleAllDay(){
    const allDay = document.getElementById('t_allDay').value === 'true';
    const st = document.getElementById('t_startTime');
    const et = document.getElementById('t_endTime');
    st.disabled = allDay; et.disabled = allDay;
    if(allDay){ st.value=''; et.value=''; }
  }

  async function createTask(){
    try{
      const payload = {
        'Subject': document.getElementById('t_subject').value.trim(),
        'Start Date': document.getElementById('t_startDate').value.trim(),
        'End Date': document.getElementById('t_endDate').value.trim(),
        'Start Time': document.getElementById('t_startTime').value.trim(),
        'End Time': document.getElementById('t_endTime').value.trim(),
        'Category': document.getElementById('t_category').value,
        'Priority': document.getElementById('t_priority').value,
        'Recurrence': document.getElementById('t_rrule').value.trim(),
        'Repeat Count': document.getElementById('t_repeatCount').value.trim(),
        'Tags': document.getElementById('t_tags').value.trim(),
        'Notes': document.getElementById('t_notes').value.trim(),
        '__allDay': document.getElementById('t_allDay').value === 'true'
      };
      await callWebApp('createTask', payload);
      setStatus('Task created.', 'success');
      clearTaskForm();
      loadTasks();
    }catch(e){ setStatus(e.message, 'danger'); }
  }

  function clearTaskForm(){
    ['t_subject','t_startDate','t_endDate','t_startTime','t_endTime','t_rrule','t_repeatCount','t_tags','t_notes'].forEach(id=>{
      document.getElementById(id).value='';
    });
    document.getElementById('t_category').value='Tasks';
    document.getElementById('t_priority').value='Medium';
    document.getElementById('t_allDay').value='false';
    toggleAllDay();
  }

  async function loadTasks(){
    try{
      const list = await callWebApp('getTasks');
      const tbody = document.getElementById('tasksTbody');
      tbody.innerHTML='';
      list.forEach(t => {
        const tr = document.createElement('tr');
        const startStr = t['Start Date'] + (t['Start Time']? (' ' + t['Start Time']) : '');
        const endStr = (t['End Date']||'') + (t['End Time']? (' ' + t['End Time']) : '');
        const isAllDay = !t['Start Time'] && !t['End Time'];
        tr.innerHTML = `
          <td>${escapeHtml(t['Subject']||'')}</td>
          <td>${escapeHtml(startStr)}</td>
          <td>${escapeHtml(endStr)}</td>
          <td>${isAllDay ? 'Yes' : 'No'}</td>
          <td>${escapeHtml(t['Category']||'')}</td>
          <td>${escapeHtml(t['Priority']||'')}</td>
          <td><span class="muted">${escapeHtml(t['Recurrence']||'')}</span></td>
          <td><input type="checkbox" ${t['Is it Completed']? 'checked' : ''} onchange="toggleDone(${t._rowIndex}, this.checked)"/></td>
          <td><button onclick="removeTask(${t._rowIndex})">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });
    }catch(e){ setStatus(e.message, 'danger'); }
  }

  async function toggleDone(rowIndex, checked){
    try{
      // minimal update: only Is it Completed
      await callWebApp('updateTask', { _rowIndex: rowIndex, 'Is it Completed': !!checked });
      setStatus('Updated.', 'success');
    }catch(e){ setStatus(e.message, 'danger'); }
  }

  async function removeTask(rowIndex){
    if(!confirm('Delete this task (and its calendar event)?')) return;
    try{
      await callWebApp('deleteTask', { _rowIndex: rowIndex });
      setStatus('Deleted.', 'success');
      loadTasks();
    }catch(e){ setStatus(e.message, 'danger'); }
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  // eager load settings/tasks if URL already saved
  if(state.url){ loadSettings().then(loadTasks).catch(()=>{}); }
</script>
</body>
</html>
